{% extends "base.html" %}

{% block title %}Predictions - 3. Liga Predictor{% endblock %}

{% block content %}
<div class="header-section">
    <h2>Upcoming Match Predictions</h2>
    <div class="controls">
        <label for="strategy">Strategy:</label>
        <select id="strategy" onchange="loadPredictions()">
            <option value="balanced">Balanced</option>
            <option value="conservative">Conservative</option>
            <option value="aggressive">Aggressive</option>
            <option value="safe">Safe (Winner Focus)</option>
        </select>

        <label for="days">Days ahead:</label>
        <select id="days" onchange="loadPredictions()">
            <option value="7" selected>7 days</option>
            <option value="14">14 days</option>
            <option value="30">30 days</option>
        </select>

        <button onclick="loadCurrentMatchday()" class="btn">Current Matchday</button>
    </div>
</div>

<div id="loading" class="loading">Loading predictions...</div>
<div id="error" class="error" style="display: none;"></div>

<div id="predictions-container">
    <!-- Predictions will be loaded here -->
</div>

<script>
    async function loadPredictions() {
        const strategy = document.getElementById('strategy').value;
        const days = document.getElementById('days').value;
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const container = document.getElementById('predictions-container');

        loading.style.display = 'block';
        error.style.display = 'none';
        container.innerHTML = '';

        try {
            const response = await fetch(`/api/upcoming_predictions?strategy=${strategy}&days=${days}`);
            const data = await response.json();

            loading.style.display = 'none';

            if (!data.success) {
                error.textContent = data.error || 'Failed to load predictions';
                error.style.display = 'block';
                return;
            }

            if (data.predictions.length === 0) {
                container.innerHTML = '<p class="no-data">No upcoming matches found</p>';
                return;
            }

            displayPredictions(data.predictions);
        } catch (err) {
            loading.style.display = 'none';
            error.textContent = 'Error loading predictions: ' + err.message;
            error.style.display = 'block';
        }
    }

    async function loadCurrentMatchday() {
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const container = document.getElementById('predictions-container');

        loading.style.display = 'block';
        error.style.display = 'none';
        container.innerHTML = '';

        try {
            const response = await fetch('/api/current_matchday');
            const data = await response.json();

            loading.style.display = 'none';

            if (!data.success) {
                error.textContent = data.error || 'Failed to load matchday';
                error.style.display = 'block';
                return;
            }

            if (data.predictions.length === 0) {
                container.innerHTML = `<p class="no-data">No upcoming matches in matchday ${data.matchday}</p>`;
                return;
            }

            container.innerHTML = `<h3>Matchday ${data.matchday}</h3>`;
            displayPredictions(data.predictions);
        } catch (err) {
            loading.style.display = 'none';
            error.textContent = 'Error loading matchday: ' + err.message;
            error.style.display = 'block';
        }
    }

    function displayPredictions(predictions) {
        const container = document.getElementById('predictions-container');

        predictions.forEach(pred => {
            const matchCard = document.createElement('div');
            matchCard.className = 'match-card';

            const homeWinWidth = pred.home_win_probability;
            const drawWidth = pred.draw_probability;
            const awayWinWidth = pred.away_win_probability;

            matchCard.innerHTML = `
                <div class="match-header">
                    <span class="match-date">${pred.date}</span>
                    <span class="match-matchday">Matchday ${pred.matchday}</span>
                </div>
                <div class="match-teams">
                    <div class="team home-team">
                        <span class="team-name">${pred.home_team}</span>
                    </div>
                    <div class="match-score">
                        <span class="predicted-score">${pred.predicted_score}</span>
                        <span class="confidence">Confidence: ${pred.confidence}%</span>
                    </div>
                    <div class="team away-team">
                        <span class="team-name">${pred.away_team}</span>
                    </div>
                </div>
                <div class="probability-bar">
                    <div class="prob-segment home-win" style="width: ${homeWinWidth}%">
                        <span>${pred.home_win_probability}%</span>
                    </div>
                    <div class="prob-segment draw" style="width: ${drawWidth}%">
                        <span>${pred.draw_probability}%</span>
                    </div>
                    <div class="prob-segment away-win" style="width: ${awayWinWidth}%">
                        <span>${pred.away_win_probability}%</span>
                    </div>
                </div>
                <div class="probability-labels">
                    <span>Home Win</span>
                    <span>Draw</span>
                    <span>Away Win</span>
                </div>
            `;

            container.appendChild(matchCard);
        });
    }

    // Load predictions on page load
    window.onload = loadPredictions;
</script>
{% endblock %}
