{% extends "base.html" %}

{% block title %}Predictions - 3. Liga Predictor{% endblock %}

{% block content %}
<div class="header-section">
    <h2>Upcoming Match Predictions</h2>
    <div class="controls">
        <label for="days">Days ahead:</label>
        <select id="days" onchange="loadPredictions('days')">
            <option value="7" selected>7 days</option>
            <option value="14">14 days</option>
            <option value="30">30 days</option>
        </select>

        <label for="matchday">or Matchday:</label>
        <input type="number" id="matchday" min="1" max="38" onchange="loadPredictions('matchday')" placeholder="e.g. 5">

        <button onclick="loadCurrentMatchday()" class="btn">Current Matchday</button>
    </div>
</div>

<div id="loading" class="loading">Loading predictions...</div>
<div id="error" class="error" style="display: none;"></div>

<div id="predictions-container">
    <!-- Predictions will be loaded here -->
</div>

<script>
    async function loadPredictions(source) {
        const daysInput = document.getElementById('days');
        const matchdayInput = document.getElementById('matchday');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const container = document.getElementById('predictions-container');

        // Clear the other input to avoid confusion
        if (source === 'days') {
            matchdayInput.value = '';
        } else if (source === 'matchday') {
            daysInput.value = '7'; // Reset to default
        }

        const days = daysInput.value;
        const matchday = matchdayInput.value;

        loading.style.display = 'block';
        error.style.display = 'none';
        container.innerHTML = '';

        try {
            let apiUrl = '/api/upcoming_predictions';
            if (matchday) {
                apiUrl += `?matchday=${matchday}`;
            } else {
                apiUrl += `?days=${days}`;
            }

            const response = await fetch(apiUrl);
            const data = await response.json();

            loading.style.display = 'none';

            if (!data.success) {
                error.textContent = data.error || 'Failed to load predictions';
                error.style.display = 'block';
                return;
            }

            if (data.predictions.length === 0) {
                container.innerHTML = '<p class="no-data">No upcoming matches found</p>';
                return;
            }

            displayPredictions(data.predictions);
        } catch (err) {
            loading.style.display = 'none';
            error.textContent = 'Error loading predictions: ' + err.message;
            error.style.display = 'block';
        }
    }

    async function loadCurrentMatchday() {
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const container = document.getElementById('predictions-container');

        loading.style.display = 'block';
        error.style.display = 'none';
        container.innerHTML = '';

        try {
            const response = await fetch('/api/current_matchday');
            const data = await response.json();

            loading.style.display = 'none';

            if (!data.success) {
                error.textContent = data.error || 'Failed to load matchday';
                error.style.display = 'block';
                return;
            }

            if (data.predictions.length === 0) {
                container.innerHTML = `<p class="no-data">No upcoming matches in matchday ${data.matchday}</p>`;
                return;
            }

            container.innerHTML = `<h3>Matchday ${data.matchday}</h3>`;
            displayPredictions(data.predictions);
        } catch (err) {
            loading.style.display = 'none';
            error.textContent = 'Error loading matchday: ' + err.message;
            error.style.display = 'block';
        }
    }

    function displayPredictions(predictions) {
        const container = document.getElementById('predictions-container');

        predictions.forEach(pred => {
            const matchLink = document.createElement('a');
            matchLink.href = `/match/${pred.match_id}`;
            matchLink.className = 'match-card-link';

            const matchCard = document.createElement('div');
            matchCard.className = 'match-card';

            const homeWinWidth = pred.home_win_probability;
            const drawWidth = pred.draw_probability;
            const awayWinWidth = pred.away_win_probability;

            matchCard.innerHTML = `
                <div class="match-header">
                    <span class="match-date">${pred.date}</span>
                    <span class="match-matchday">Matchday ${pred.matchday}</span>
                </div>
                <div class="match-teams">
                    <div class="team home-team">
                        <span class="team-name">${pred.home_team}</span>
                    </div>
                    <div class="match-score">
                        <span class="predicted-score">${pred.predicted_score}</span>
                        <span class="confidence">Confidence: ${pred.confidence}%</span>
                        <span class="expected-goals">Expected Goals: ${pred.home_expected_goals.toFixed(2)} - ${pred.away_expected_goals.toFixed(2)}</span>
                    </div>
                    <div class="team away-team">
                        <span class="team-name">${pred.away_team}</span>
                    </div>
                </div>
                <div class="probability-bar">
                    <div class="prob-segment home-win" style="width: ${homeWinWidth}%">
                        <span>${pred.home_win_probability}%</span>
                    </div>
                    <div class="prob-segment draw" style="width: ${drawWidth}%">
                        <span>${pred.draw_probability}%</span>
                    </div>
                    <div class="prob-segment away-win" style="width: ${awayWinWidth}%">
                        <span>${pred.away_win_probability}%</span>
                    </div>
                </div>
                <div class="probability-labels">
                    <span>Home Win</span>
                    <span>Draw</span>
                    <span>Away Win</span>
                </div>
            `;

            matchLink.appendChild(matchCard);
            container.appendChild(matchLink);
        });
    }

    // Load predictions on page load
    window.onload = () => loadPredictions('days');
</script>
{% endblock %}


