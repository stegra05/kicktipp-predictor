{% extends "base.html" %}

{% block title %}Statistics - 3. Liga Predictor{% endblock %}

{% block content %}
<div class="header-section">
    <h2>Prediction Performance Statistics</h2>
</div>

<div id="loading" class="loading">Loading statistics...</div>
<div id="error" class="error" style="display: none;"></div>

<div id="stats-container">
    <!-- Statistics will be loaded here -->
</div>

<script>
    async function loadStatistics() {
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const container = document.getElementById('stats-container');

        loading.style.display = 'block';
        error.style.display = 'none';
        container.innerHTML = '';

        try {
            const [perfResponse, qualityResponse] = await Promise.all([
                fetch('/api/performance'),
                fetch('/api/model_quality')
            ]);

            const perfData = await perfResponse.json();
            const qualityData = await qualityResponse.json();

            loading.style.display = 'none';

            if (!perfData.success) {
                error.textContent = perfData.error || 'Failed to load performance statistics';
                error.style.display = 'block';
                return;
            }
            if (!qualityData.success) {
                // Non-critical, so we can still display performance stats
                console.error('Failed to load model quality stats:', qualityData.error);
            }

            displayStatistics(perfData.stats, qualityData.metrics);
        } catch (err) {
            loading.style.display = 'none';
            error.textContent = 'Error loading statistics: ' + err.message;
            error.style.display = 'block';
        }
    }

    function displayStatistics(stats, metrics) {
        const container = document.getElementById('stats-container');

        if (stats.total_predictions === 0) {
            container.innerHTML = '<p class="no-data">No predictions evaluated yet. Predictions will appear here once matches are completed.</p>';
            return;
        }

        const projectedSeason = (stats.avg_points_per_match * 38).toFixed(1);

        let qualityMetricsHtml = '';
        if (metrics) {
            qualityMetricsHtml = `
                <div class="header-section">
                    <h2>Model Quality Metrics</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Brier Score</h3>
                        <div class="stat-value">${metrics.brier_score.toFixed(3)}</div>
                        <div class="stat-label">Lower is better</div>
                    </div>
                    <div class="stat-card">
                        <h3>Log Loss</h3>
                        <div class="stat-value">${metrics.log_loss.toFixed(3)}</div>
                        <div class="stat-label">Lower is better</div>
                    </div>
                    <div class="stat-card">
                        <h3>Ranked Probability Score</h3>
                        <div class="stat-value">${metrics.rps.toFixed(3)}</div>
                        <div class="stat-label">Lower is better</div>
                    </div>
                </div>
            `;
        }

        container.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card highlight">
                    <h3>Total Points</h3>
                    <div class="stat-value">${stats.total_points}</div>
                    <div class="stat-label">from ${stats.total_predictions} predictions</div>
                </div>

                <div class="stat-card highlight">
                    <h3>Average Points/Match</h3>
                    <div class="stat-value">${stats.avg_points_per_match.toFixed(2)}</div>
                    <div class="stat-label">Projected season: ${projectedSeason} pts</div>
                </div>

                <div class="stat-card">
                    <h3>Exact Scores</h3>
                    <div class="stat-value">${stats.exact_scores}</div>
                    <div class="stat-label">${stats.exact_score_percentage.toFixed(1)}% (4 points)</div>
                </div>

                <div class="stat-card">
                    <h3>Correct Differences</h3>
                    <div class="stat-value">${stats.correct_differences}</div>
                    <div class="stat-label">${stats.difference_percentage.toFixed(1)}% (3 points)</div>
                </div>

                <div class="stat-card">
                    <h3>Correct Results</h3>
                    <div class="stat-value">${stats.correct_results}</div>
                    <div class="stat-label">${stats.result_percentage.toFixed(1)}% (2 points)</div>
                </div>

                <div class="stat-card">
                    <h3>Incorrect</h3>
                    <div class="stat-value">${stats.incorrect}</div>
                    <div class="stat-label">${stats.incorrect_percentage.toFixed(1)}% (0 points)</div>
                </div>
            </div>

            <div class="accuracy-chart">
                <h3>Accuracy Breakdown</h3>
                <div class="chart-bar">
                    <div class="bar-segment exact" style="width: ${stats.exact_score_percentage}%">
                        <span>${stats.exact_score_percentage.toFixed(1)}%</span>
                    </div>
                    <div class="bar-segment difference" style="width: ${stats.difference_percentage}%">
                        <span>${stats.difference_percentage.toFixed(1)}%</span>
                    </div>
                    <div class="bar-segment result" style="width: ${stats.result_percentage}%">
                        <span>${stats.result_percentage.toFixed(1)}%</span>
                    </div>
                    <div class="bar-segment incorrect" style="width: ${stats.incorrect_percentage}%">
                        <span>${stats.incorrect_percentage.toFixed(1)}%</span>
                    </div>
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <span class="legend-color exact"></span>
                        <span>Exact Score</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color difference"></span>
                        <span>Correct Difference</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color result"></span>
                        <span>Correct Result</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color incorrect"></span>
                        <span>Incorrect</span>
                    </div>
                </div>
            </div>

            ${qualityMetricsHtml}

            <div class="header-section">
                <h2>Model Visualizations</h2>
            </div>
            <div class="plots-container">
                <div class="plot">
                    <h3>Confusion Matrix</h3>
                    <img src="/static/plots/confusion_matrix.png" alt="Confusion Matrix">
                </div>
                <div class="plot">
                    <h3>Calibration Curve (Home Win)</h3>
                    <img src="/static/plots/calibration_curve_home.png" alt="Calibration Curve Home Win">
                </div>
                <div class="plot">
                    <h3>Calibration Curve (Draw)</h3>
                    <img src="/static/plots/calibration_curve_draw.png" alt="Calibration Curve Draw">
                </div>
                <div class="plot">
                    <h3>Calibration Curve (Away Win)</h3>
                    <img src="/static/plots/calibration_curve_away.png" alt="Calibration Curve Away Win">
                </div>
            </div>
        `;
    }

    window.onload = loadStatistics;
</script>
{% endblock %}


